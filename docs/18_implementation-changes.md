# 実装変更履歴

## 2024年 数学的レベルデザインへの変更

### 削除した機能
- 動的バランスシステム（calculateWaveBalance関数）
  - 配置済みタワーの火力から敵HPを動的に計算していた
  - プレイヤーの戦略性が失われる問題があった

### 追加した機能

#### 1. 理論値ベースのレベルデザイン
- `calculateCumulativeCoins`: Wave毎の累積コイン計算
- `calculateTheoreticalDPS`: 理論上の最適火力計算
- `getEnemyHPForWave`: Wave別の敵HP計算

#### 2. 難易度システム
3つの難易度モードを追加：
- **Easy**: コイン1.5倍、敵HP0.8倍、パッシブインカム2倍
- **Normal**: 標準設定
- **Hard**: コイン0.8倍、敵HP1.2倍、パッシブインカム0.5倍

### 計算式の詳細

#### 累積コイン計算
```javascript
累積コイン = 初期コイン(80) + Σ(Wave報酬) + Σ(パッシブインカム)
Wave報酬 = 敵数 × 平均報酬(10)
パッシブインカム = レベル × 30秒
```

#### 理論火力計算
```javascript
1. 利用可能な国家をコスト効率(DPS/コスト)でソート
2. 最も効率的な組み合わせで配置
3. 同一国家は最大3つまでの制限
```

#### 敵HP計算
```javascript
基本HP = 理論火力 × 通過時間 × 難易度係数
難易度係数 = 0.6 + (Wave - 1) × 0.01 (最大0.8)

敵タイプ別倍率:
- soldier: 1.0x
- jet: 0.8x
- tank: 2.0x
- elite: 3.0x
- boss: 5.0x
```

### 改善効果
1. **予測可能なゲームバランス**: 各Waveの難易度が数式で定義
2. **戦略性の向上**: 理論値の60-80%で撃破可能なため、プレイヤーの工夫が重要
3. **難易度調整の柔軟性**: コイン獲得速度で難易度を調整可能
4. **敵HPの適正化**: 理論値ベースで計算されるため、過度に高いHPが解消